@using sReportsV2.Common.Constants;
@{
    var userCookieData = ViewBag.UserCookieData;
    var canAddEoC = userCookieData.UserHasPermission(PermissionNames.AddEpisodeOfCare, ModuleNames.Patients);
}
@model sReportsV2.DTOs.Patient.PatientDataOut

@if (Model != null)
{
    <div class="patient-tree" id="patientTree" data-patientid="@Model.Id">
        <div class="patient-tree-header">
            <div class="patient-tree-title tree-form-title">
                @sReportsV2.Resources.TextLanguage.Episodes_of_cares
            </div>
            @if (canAddEoC)
            {
                <button type="button" class="btn btn-add-new float-right" onclick="addNewEpisodeOfCare('@Model.Id')">
                    <i class="fas fa-plus-circle resize-circle"></i> <span class="text-add-new"> @sReportsV2.Resources.TextLanguage.Add_New</span>
                </button>
            }
        </div>
        @if (Model.EpisodeOfCares != null && Model.EpisodeOfCares.Count > 0)
        {
            for (int i = 0; i < Model.EpisodeOfCares.Count; i++)
            {
                <div class="single-episode-of-care-container" id="@Model.EpisodeOfCares[i].Id">
                    <div class="vertical-line" style="display: none;">&nbsp;</div>
                    <div class="eoc-information">
                        <div class="eoc-main-content">
                            <span class="arrow-icon">
                            </span>
                            <span class="title">
                                @(Model.EpisodeOfCares[i].DiagnosisRole != null && Model.EpisodeOfCares[i].DiagnosisRole.Thesaurus != null ? Model.EpisodeOfCares[i].DiagnosisRole.Thesaurus.GetPreferredTermByTranslationOrDefault(ViewBag.UserCookieData.ActiveLanguage) : "Not defined")
                            </span>
                            <span class="status">
                                @sReportsV2.Resources.TextLanguage.ResourceManager.GetString(Model.EpisodeOfCares[i].Status)
                            </span>
                        </div>
                        <div class="dates">
                            <div class="start-date">
                                <span class="calendar-icon">
                                    <img src="~/Content/img/icons/calendar_green.svg" />
                                </span>
                                <span class="calendar-text">
                                    @(Model.EpisodeOfCares[i].Period.StartDate.ToString(ViewBag.DateFormat))
                                </span>
                            </div>
                            <div class="end-date">
                                <span class="calendar-icon">
                                    @if (Model.EpisodeOfCares[i].Period.EndDate != null)
                                    {
                                        <img src="~/Content/img/icons/calendar_green.svg" />

                                    }
                                </span>
                                <span class="calendar-text">
                                    @(Model.EpisodeOfCares[i].Period.EndDate != null ? Model.EpisodeOfCares[i].Period.EndDate.Value.ToString(ViewBag.DateFormat) : "")
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="encounter-container">
                        @if (userCookieData.UserHasPermission(PermissionNames.AddEncounter, ModuleNames.Patients))
                        {
                            <div class="add-new-button" onclick="addNewEncounter(event, '@Model.EpisodeOfCares[i].Id')">
                                <span class="icon-plus">
                                    <img src="~/Content/img/icons/add_new.svg" />
                                </span>
                                <span class="label">
                                    @sReportsV2.Resources.TextLanguage.Add_new_encounter
                                </span>
                            </div>
                        }
                        <div class="encounter-container-items">
                            @if (Model.EpisodeOfCares[i].Encounters != null)
                            {
                                @Html.Partial("~/Views/Encounter/PatientTreeEncounterItems.cshtml", Model.EpisodeOfCares[i].Encounters)
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-episode-of-care-placeholder">
                <img src="~/Content/img/icons/placeholder_patient.svg" />
                <div class="no-result-text">
                    @sReportsV2.Resources.TextLanguage.There_is_no_any_Episode_of_care_added<br />
                    @sReportsV2.Resources.TextLanguage.Add_an_Episode_of_Care
                </div>
            </div>
        }
    </div>
}


<script>
    @if (ViewBag.IsPageReload != null && ViewBag.IsPageReload)
    {
        <text>
            $(document).ready(function () {
                setDefaultTreeSelectedValue('@ViewBag.ActiveElementParent', '@ViewBag.ActiveElement', '@ViewBag.ActiveElementType', @(canAddEoC ? "true" : ""))
            })
        </text>
    }
</script>