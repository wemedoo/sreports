@using sReportsV2.DTOs.FormDistribution.DataOut
@using sReportsV2.Domain.Entities.Constants
@{
    var controller = ViewContext.Controller as sReportsV2.Controllers.FormDistributionController;
}
@{
    ViewBag.Title = "GetByThesaurusId";
}

@model FormDistributionDataOut
<h1>
    @Model.Title
    <div>(@sReportsV2.Resources.TextLanguage.DefineDistributionsParameters)</div>
</h1>
<form onsubmit="return submitDistributionConfigForm()" id="distributionForm">
    <input type="hidden" id="formDistributionId" name="formDistributionId" value="@Model.Id" />
    <input type="hidden" id="lastUpdate" name="lastUpdate" value="@Model.LastUpdate" />
    <input type="hidden" id="thesaurusId" name="thesaurusId" value="@Model.ThesaurusId" />
    <div class="row">
        @foreach (FormFieldDistributionDataOut field in Model.Fields)
        {


                <fieldset id="@field.Id" data-fieldtype="@field.Type" class="form-fieldset field col-md-12 col-lg-6">
                    <h3 style="padding-top: 50px">
                        @field.Label
                        <a href="#" class="add-relation-link" onclick="addRelation(event,'@field.Id')"><b>Add relation +</b></a>

                    </h3>
                    @*<div class="nondependent-probability">@Html.Raw(fieldData)</div>*@
                    
                <div class="dependent-probability" id="@field.Id-probabilities">@Html.Partial("RenderInputs", field)</div>
                </fieldset>
            }

    </div>
    <div class="form-button-container">
        <input type="submit" class="btn btn-primary" id='submitBtn' value="Submit" />
    </div>
</form>

<!-- Modal -->
<div class="modal fade" id="relationModal" tabindex="-1" role="dialog" aria-labelledby="relationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="relationModalLabel">Select relation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset class="form-element form-select">
                        <select id="relation-item" class="form-element-field -hasvalue">
                            <option value="">Please select field</option>
                            @foreach (FormFieldDistributionDataOut field in Model.Fields.Where(x => x.Type == FieldTypes.Number || x.Type == FieldTypes.Radio || x.Type == FieldTypes.Digits || x.Type == FieldTypes.Checkbox || x.Type == FieldTypes.Select))
                            {
                                <option value="@field.Id" data-type="@field.Type">@field.Label</option>
                            }
                        </select>
                        <div class="form-element-bar"></div>

                        <div class="form-element-description">

                        </div>
                    </fieldset>


                    <div class="boundaries-container">
                        <fieldset class="form-element form-input">
                            <label for="lowerBoundary" class="form-element-label">
                                Lower boundary
                            </label>
                            <input type="number" step="0.01" name="lowerBoundary" required class="form-element-field" id="lowerBoundary" placeholder="Define lower boundary" />
                            <div class="form-element-bar"></div>
                        </fieldset>
                        <fieldset class="form-element form-input">
                            <label for="upperBoundary" class="form-element-label">
                                Upper boundary
                            </label>
                            <input type="number" step="0.01" name="upperBoundary" required class="form-element-field" id="upperBoundary" placeholder="Define upper boundary" />
                            <div class="form-element-bar"></div>
                        </fieldset>
                    </div>
                    <input type="hidden" id="targetVariable" />
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="createRelatedField()">Save changes</button>
            </div>
        </div>
    </div>
</div>


<script>

    $(document).ready(function () {
        jQuery.validator.addMethod("sumEqualToZero", function (value, element) {
            var sumOfVals = +parseFloat($(element).val()).toFixed(2);
            var parent = $(element).parent();
            $(parent).siblings('fieldset').each(function (index, element) {
                let input = $(element).find('input');
                if (input) {
                    sumOfVals += +parseFloat($(input).val()).toFixed(2);
                }
            });
            if (+parseFloat(sumOfVals).toFixed(2) == 1) return true;
            return false;
        }, "* Sum must be equal to one");

        $('#distributionForm').validate({
            onkeyup: false,
             @*rules: {

               @foreach (FormFieldDistributionDataOut data in Model.Fields.Where(x => x.Type == FieldTypes.Radio))
                {
                    foreach(FormFieldValueDistributionDataOut value in data.Values)
                    {
                        <text> 'success_probability_@value.ThesaurusId': { sumEqualToZero: true },</text>
                    }
                }
            },
            groups: {
                @foreach (FormFieldDistributionDataOut data in Model.Fields.Where(x => x.Type == FieldTypes.Radio))
                {
                    <text>
                        @data.Id:'@(string.Join(" ",data.Values.Select(x => "success_probability_" +@x.ThesaurusId)))',
                    </text>

                }
            }*@
        });
    })



</script>
<script src="~/Scripts/sReports/formDistribution.js"></script>